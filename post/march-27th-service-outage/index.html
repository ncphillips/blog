<!doctype html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Forestry.io Blog</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://forestry.io/docs/images/favicon.ico" rel="shortcut icon" type="image/x-icon">
  <link rel="icon" type="image/png" href="https://forestry.io/docs/images/favicon.png-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="https://forestry.io/docs/images/favicon-16x16.png" sizes="16x16" />
  <link rel="stylesheet" href="https://yui-s.yahooapis.com/pure/0.6.0/pure-min.css">
  
  
  <link rel="stylesheet" href="https://yui-s.yahooapis.com/pure/0.6.0/grids-responsive-min.css">
  
  <link rel="stylesheet" href="https://forestry.io/blog//css/main.css">
  <script src="https://use.fonticons.com/b6f38602.js"></script>

  

  

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@forestryio">
  <meta name="twitter:creator" content="@scottgallant">
  <meta name="twitter:title" content="March 27th Service Outage">
  <meta name="twitter:description" content="A post mortem on the Forestry service outage">
  <meta name="twitter:image" content="https://forestry.io/blog//images/forestry-outage-3.png">

  
  <meta property="og:url" content="https://forestry.io/blog/post/march-27th-service-outage/" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="March 27th Service Outage" />
  <meta property="og:description" content="A post mortem on the Forestry service outage" />
  <meta property="og:image" content="https://forestry.io/blog//images/forestry-outage-3.png" />
  <meta property="fb:app_id" content="1628812937372396" />

</head>
<body>

<header class="site-header">
  <div class="container">
    <h1 class="logo"><a href="https://forestry.io">Forestry.io</a></h1>
    <nav class="main-nav">
      <ul id="menu">
        <li><a href="https://forestry.io/plans">Pricing</a></li>
        <li><a href="https://forestry.io/docs/">Docs</a></li>
        <li class="current"><a href="https://forestry.io/blog/">Blog</a></li>
        <li><a href="https://forestry.io/login">Login</a></li>
        <li><a href="https://forestry.io/signup">Sign up</a></li>
      </ul>
    </nav>
  </div>
</header>




<div class="container pure-g  single-post">
	<div class="pure-u-1 banner-container">
		
			
			
			
					<div class="profile-img">
						<img src="https://forestry.io/blog//images/jordan-small.png" alt="Jordan Patterson">
					</div>
			
		
		<div class="post-banner-image">
			<img src="https://forestry.io/blog/images/forestry-outage-2.png" alt="March 27th Service Outage">
		</div>
	</div>
	<div class="pure-u-1 main-column">
		<header class="post-header">
		<h1>March 27th Service Outage</h1>
		
			
			
			
			<div class="author-date"><a href="" target="_blank">Jordan Patterson</a> Mar 27 2017</div>
			
		
		</header>
		<div class="content">
			
			
			

			<h2></h2>

			<p>As some of you may have noticed, Forestry was down for about 2.5 hours between 23:00 UTC March 27 until 01:30 UTC March 28. In the spirit of full disclosure I&rsquo;d like to explain what happened and why.</p>

<p>Forestry is a Rails application and from time to time the number of migrations we have get unwieldy. Being an application under rapid development, things are constantly changing and migrations are created sometimes daily. To keep this every growing list of files at bay we use a tool called 
<a href="https://github.com/jalkoby/squasher" style="font-size: 1rem; background-color: rgb(255, 255, 255);">squasher</a>
<span style="font-size: 1rem;">&nbsp;to squash our migrations into a single migration.</span></p>

<p>The way squasher works is by taking the current state of the database and adding it to a migration with a filename that reflects the most recent migration that has run. This prevents the squashed migration from running when the database is migrated. This migration shouldn&rsquo;t run because, as it turns out, it will delete your entire database. The create_table statements are suffixed with <code>force: :cascade</code> which drops the table and all the related tables then recreates them. I think you can see where I am going.</p>

<p>I ran squasher on our migrations in dry run mode (as I have done before) to ensure that everything looked ok. Dry run mode creates the new squashed migration so that it can be inspected. My mistake was that I forgot to delete the migration that the dry run created before I ran it for real. On the subsequent run squasher picked up on the new migration, which didn&rsquo;t have a record in the database because it had never been run. The new squashed migration now had a name that did not exist in our production database and so when it ran, wiped our entire production database clean. The migration was run in development, but it was on a clean database so the issue wasn&rsquo;t noticed. And frankly, I wasn&rsquo;t worried because &ldquo;I&rsquo;ve done this before&rdquo;.</p>

<p>But&hellip; this is why we have backups. Our production database runs on 
<a href="https://aws.amazon.com/rds/" style="font-size: 1rem; background-color: rgb(255, 255, 255);">Amazon&nbsp;RDS</a>
<span style="font-size: 1rem;">&nbsp;in a multi-az deployment. By the time the issue was noticed, the changes had already propagated to the failover instance so we had to go back to a point-in-time restore. So we took the site offline and searched our logs to find the most recent successful API request (this was the longest part). Once we found that, it was just a few clicks (and some waiting) to get a restored copy of the database back up and running. All in all, we lost &lt; 1min worth of data.</span></p>

<p>Once service was restored, we had a backlog jobs that needed to be processed. You may have experienced slow publish/preview/import times while we churned through them. After about 30 mins of Forestry coming back online everything was back to normal.</p>

<p>TLDR; Accidentally deleted our production database by way of a bad migration so we had to restore from a backup.</p>

<p><span style="font-size: .8em;"><em>Thanks to
<a href="https://thenounproject.com/rockicon/">Rockicon</a> for the great DB icon on this post!</em></span></p>


			
			
			

			
				
				
				<div class="author-block media">
					<div class="left">
						<div class="profile-img">
							<img src="https://forestry.io/blog//images/jordan-small.png" alt="Jordan Patterson">
						</div>
					</div>
					<div class="right">
						<h2><span>Author</span> Jordan Patterson</h2>
						<p>
							CTO and Co-founder of <a href='https://forestry.io' title='Forestry.io CMS'>Forestry.io</a>.
						</p>
					</div>
				</div>
				
			

			
				<div class="newsletter-block">
  <h2>Nerd out on Static</h2>
  <p class="subtitle">
    Join 3000+ other geeks and get the newsletter
  </p>
  <form action="//Forestry.us11.list-manage.com/subscribe/post?u=258a7a7e66229ee7fff436898&amp;id=377858cce3" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate newsletter pure-form" target="_blank" novalidate>
    <input type="email" placeholder="Email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
    <div id="mce-responses" class="clear">
  		<div class="response" id="mce-error-response" style="display:none"></div>
  		<div class="response" id="mce-success-response" style="display:none"></div>
  	</div>
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_258a7a7e66229ee7fff436898_377858cce3" tabindex="-1" value=""></div>
    <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button primary">
  </form>
</div>

			

			
				<div class="disqus">
					<div id="disqus_thread"></div>
						<script>

						

						

						(function() { 
						    var d = document, s = d.createElement('script');
						    s.src = '//forestry-io.disqus.com/embed.js';
						    s.setAttribute('data-timestamp', +new Date());
						    (d.head || d.body).appendChild(s);
						})();
						</script>
				</div>
			
		</div>
	</div>
	

</div>
<footer class="site-footer">
<p>forestry.io, the CMS for static sites</p>
<p><a href="#">Terms of service</a> &bull; <a href="#">Privacy policy</a></p>
<p>
  <a href="https://forestry.io/blog/admin/"><span class="icon icon-key"></span> Edit</a>
</p>
</footer>

<script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
<script src="https://forestry.io/blog//js/main.min.js"></script>
<script id="dsq-count-scr" src="//forestry-io.disqus.com/count.js" async></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-39666952-5', 'auto');
  ga('send', 'pageview');

</script>
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '1628812937372396',
      xfbml      : true,
      version    : 'v2.7'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>

<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57b123938427fbd8"></script>
</body>
</html>

